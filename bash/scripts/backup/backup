#!/bin/bash
set -euo pipefail

# Backup script for the home directory

TIMESTAMP="$(date '+%Y-%m-%d_%H-%M-%S')"   # safer filename timestamp
DEST_DIR="$HOME/backups"
SOURCE_DIR="$HOME"
ARCHIVE_PATH="$DEST_DIR/home_backup_${TIMESTAMP}.tar.gz"
LOG_FILE="$DEST_DIR/backup.log"

mkdir -p "$DEST_DIR"

# Create the archive quietly (no -v), excluding the backups directory itself
# Log tar output/errors to the log file
if tar --exclude="$DEST_DIR" -czf "$ARCHIVE_PATH" -C "$SOURCE_DIR" . >>"$LOG_FILE" 2>&1; then
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] SUCCESS: Backup of $SOURCE_DIR -> $ARCHIVE_PATH" >>"$LOG_FILE"
  echo "Backup completed: $ARCHIVE_PATH"
else
  # With 'set -e', tar failures generally exit before reaching here, but keeping this for explicit logging.
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] ERROR: Backup failed for $SOURCE_DIR" >>"$LOG_FILE"
  echo "Backup failed. See log: $LOG_FILE" >&2
  exit 1
fi
